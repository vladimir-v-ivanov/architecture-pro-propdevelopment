## Требования к безопасности

| Требование                                       | Реализация                                                                                                                              |
|--------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| Обязательное шифрование трафика                  | Использование HTTPS (TLS 1.2/1.3) для всех запросов.                                                                                    |
| Авторизация PropDevelopment во внешней системе   | OAuth2 или другой механизм предоставляемый провайдером.                                                                                 |
| Политика минимальных прав                        | По умолчанию пользователи PropDevelopment не имеют прав доступа к услугам умного дома.                                                  |
| Внутренняя проверка прав доступа PropDevelopment | tenant-core-app проверяет права доступа пользователя к услугам умного дома.                                                             |
| Журналирование операций                          | Логирование запросов и ответов при коммуникации между системами, операций пользователей. Контроль доступа к журналам.                   |
| Контроль данных                                  | Обезличивание данных в логах. Гарантия минимальных данных в запросах во внешнюю систему, обязательно исключая секретные и персональные. |
| Защита от злоупотребления                        | Лимитирование запросов со стороны пользователя                                                                                          |
| Контроль сети                                    | Доступ к устройствам IoT возможен только внутри сети/VPN, только с разрешенных IP. По умолчанию все порты закрыты и т.д.                |

## Протоколы

Протоколы передачи данных и аутентификации во внешней системе во многом зависят от провайдера. Предположительно можно использовать HTTPS/OAuth2.
Внутри системы PropDevelopment подразумевается использование протокола REST для взаимодействия между сервисами.

## Взаимодействие

### Мобильное приложение
Взаимодействие строится по принципу одностороннего инициатора:  
**PropDevelopment** инициирует команды, а внешняя система Умный дом выступает исполнителем.

Для интеграции создаётся новый веб‑сервис **smarthome-gateway**, который отвечает за:
- обогащение данных перед отправкой во внешнюю систему;
- фильтрацию и минимизацию передаваемой информации.

### Асинхронная обработка команд
Процесс построен по принципу **Event Driven**:

1. Пользователь нажимает кнопку в мобильном приложении.  
2. **tenant-core-app** принимает запрос, проверяет права доступа, логирует активность и публикует событие в Kafka (**smarthome-queue**).  
3. **smarthome-gateway** подписан на очередь и получает событие.  
4. Получив событие, smarthome-gateway формирует минимально необходимый запрос и синхронно вызывает API внешней системы Умный дом.  
5. После получения ответа от внешней системы smarthome-gateway публикует событие результата.  
6. **tenant-core-app** подписан на события результата. При поступлении нового события он:
   - обновляет состояние в системе,
   - формирует уведомление для клиента,
   - отображает результат в приложении.

**Внешняя система Умный дом** самостоятельно взаимодействует с IoT‑устройствами (ворота, шлагбаум) по IP или другим внутренним протоколам.

### Звонок на специальный номер
Функционал открытия ворот по звонку на выделенный номер полностью реализуется на стороне провайдера Умного дома.  

- **PropDevelopment** передаёт провайдеру список разрешённых телефонных номеров (белый список).  
- Передача осуществляется через API провайдера - например, раз в сутки или по другому согласованному расписанию.  
- Проверка Caller ID и принятие решения об открытии ворот выполняется на стороне провайдера.